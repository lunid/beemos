$(document).ready(function(){tabs=$("#abas").tabs({active:0});tabTemplate="<li><a href='#{href}'>#{label}</a> <span class='ui-icon ui-icon-close'>Remove Tab</span></li>",tabCounter=3;$("#grid_listas").jqGrid({url:"listas/gridlistas",datatype:"json",colNames:["Código","Nome","Data Criação","Impressão","Resultado","Status",""],colModel:[{name:"COD_LISTA",index:"COD_LISTA",width:15,align:"center",search:true,cellattr:site.formataGrid},{name:"DESCR_ARQ",index:"DESCR_ARQ",width:40,search:true},{name:"DATA_REGISTRO",index:"DATA_REGISTRO",width:12,align:"center",search:true},{name:"VER_IMPRESSA",index:"VER_IMPRESSA",width:10,align:"center",search:false},{name:"RESULTADO",index:"RESULTADO",width:10,align:"center",search:false,sortable:false},{name:"STATUS",index:"STATUS",width:10,align:"center",search:true,sortable:false},{name:"EDITAR",index:"EDITAR",width:10,align:"center",search:false,sortable:false}],rowNum:10,rowList:[10,20,30],pager:"#pg_listas",sortname:"DATA_REGISTRO",viewrecords:true,sortorder:"DESC",caption:"Listas de Exercícios",width:750,height:"auto",scrollOffset:0});
$("#grid_listas").filterToolbar();$("#abas span.ui-icon-close").live("click",function(){var panelId=$(this).closest("li").remove().attr("aria-controls");$("#"+panelId).remove();tabs.tabs("refresh");$("#controleAbas").val($("#controleAbas").val().replace(panelId,""))})});function abreLista(idLista,nomeAba){var controleAbas=$("#controleAbas").val();var ver=controleAbas.search("editar_"+idLista);if(ver>=0){$("a[href=#editar_"+idLista+"]").trigger("click");return false}site.aguarde();$.post("listas/carregarHtmlAbaLista",{idLista:idLista},function(ret){site.fechaAguarde();if(!ret.status){site.modal(ret.msg,"Abrir Lista","erro")}else{var id="editar_"+idLista;var li=$(tabTemplate.replace(/#\{href\}/g,"#"+id).replace(/#\{label\}/g,nomeAba));tabs.find(".ui-tabs-nav").append(li);tabs.append("<div id='"+id+"'>"+ret.html+"</div>");tabs.tabs("refresh");$("#ui-id-"+tabCounter).trigger("click");tabCounter++;var date=new Date();var ano=date.getFullYear();var mes=date.getMonth();var dia=date.getDate();$(".periodo_ini").datepicker({minDate:new Date(ano,mes,dia)});
$(".periodo_fim").datepicker({minDate:new Date(ano,mes,dia)});$(".tempo_vida").mask("99:99");if(controleAbas!=""){controleAbas+=","}controleAbas+=id;$("#controleAbas").val(controleAbas);filtrosResultados(idLista);geraGrafico(idLista)}},"json").error(function(){site.fechaAguarde();alert("Falha no servidor! Tente mais tarde.")})}function verificaOptTodas(id){var ver=false;$(id+" option").each(function(){if(this.selected&&this.value==0){ver=true}});if(ver){$(id+" option").each(function(){if(this.value==0){this.selected=true}else{this.selected=false}})}return $(id).val()}function filtrosResultados(idLista){var idEscola=$("#escolas_"+idLista).val();var ensino=verificaOptTodas("#ensino_"+idLista);var periodo=verificaOptTodas("#periodo_"+idLista);var ano=verificaOptTodas("#ano_"+idLista);$.post("listas/CarregarFiltrosResultados",{idLista:idLista,idEscola:idEscola,ensino:ensino,periodo:periodo,ano:ano},function(ret){var escolasOpts="<option value='0' selected='selected'>Todas</option>";var ensinoOpts="<option value='0' selected='selected'>Todos</option>";
var periodoOpts="<option value='0' selected='selected'>Todas</option>";var anoOpts="<option value='0' selected='selected'>Todos</option>";var turmasOpts="<option value='0' selected='selected'>Todas</option>";if(ret.escolasTurmas.status){$(ret.escolasTurmas.arrEscolas).each(function(){for(var idEscola in this){escolasOpts+="<option value='"+this[idEscola].ID_ESCOLA+"'>"+this[idEscola].ESCOLA+"</option>"}});$(ret.escolasTurmas.arrEnsino).each(function(){for(var idEnsino in this){ensinoOpts+="<option value='"+this[idEnsino].ENSINO+"'>"+this[idEnsino].DESC+"</option>"}});$(ret.escolasTurmas.arrPeriodo).each(function(){for(var idPeriodo in this){periodoOpts+="<option value='"+this[idPeriodo].PERIODO+"'>"+this[idPeriodo].DESC+"</option>"}});$(ret.escolasTurmas.arrAno).each(function(){for(var idAno in this){anoOpts+="<option value='"+this[idAno]+"'>"+this[idAno]+"</option>"}});$(ret.escolasTurmas.arrTurmas).each(function(){for(var idTurma in this){turmasOpts+="<option value='"+this[idTurma].ID_TURMA+"'>"+this[idTurma].CLASSE+"</option>"
}})}if(idEscola<=0||idEscola==null){$("#escolas_"+idLista).html(escolasOpts)}if(ensino<=0||ensino==null){$("#ensino_"+idLista).html(ensinoOpts)}if(periodo<=0||periodo==null){$("#periodo_"+idLista).html(periodoOpts)}if(ano<=0||ano==null){$("#ano_"+idLista).html(anoOpts)}$("#turmas_"+idLista).html(turmasOpts)},"json")}function geraGrafico(idLista){var idEscola=$("#escolas_"+idLista).val();var ensino=$("#ensino_"+idLista).val();var periodo=$("#periodo_"+idLista).val();var ano=$("#ano_"+idLista).val();var turma=$("#turmas_"+idLista).val();site.aguarde();$.post("listas/GerarGraficosResultados",{idLista:idLista,idEscola:idEscola,ensino:ensino,periodo:periodo,ano:ano,turma:turma},function(ret){site.fechaAguarde();if(ret.status){if(ret.GR_RESPOSTAS.status){var grRespostas=new Highcharts.Chart({chart:{renderTo:"gr_respostas_"+idLista,plotBackgroundColor:null,plotBorderWidth:null,plotShadow:false,width:200,height:200,borderWidth:1,borderColor:"#909090"},exporting:{enabled:false},credits:{enabled:false},title:{text:"Respostas"},tooltip:{pointFormat:"<b>{point.y}</b>",percentageDecimals:2},plotOptions:{pie:{allowPointSelect:true,cursor:"pointer",dataLabels:{enabled:false},showInLegend:true,size:"95%"}},legend:{borderWidth:0,layout:"vertical",itemStyle:{fontSize:"10px"}},series:[{type:"pie",data:[["Corretas",ret.GR_RESPOSTAS.correta],["Erradas",ret.GR_RESPOSTAS.errada]]}]})
}else{$("#gr_respostas_"+idLista).html("<p>Respostas<br /><span>0</span></p>")}if(ret.GR_ALUNOS.status){var grAlunos=new Highcharts.Chart({chart:{renderTo:"gr_alunos_"+idLista,plotBackgroundColor:null,plotBorderWidth:null,plotShadow:false,width:200,height:200,borderWidth:1,borderColor:"#909090"},exporting:{enabled:false},credits:{enabled:false},title:{text:"Alunos"},tooltip:{pointFormat:"<b>{point.y}</b>",percentageDecimals:2},plotOptions:{pie:{allowPointSelect:true,cursor:"pointer",dataLabels:{enabled:false},showInLegend:true,size:"95%"}},legend:{borderWidth:0,layout:"vertical",itemStyle:{fontSize:"10px"}},series:[{type:"pie",data:[["Responderam",ret.GR_ALUNOS.respondeu],["Não Responderam",ret.GR_ALUNOS.naoRespondeu]]}]})}else{$("#gr_alunos_"+idLista).html("<p>Alunos<br /><span>0</span></p>")}if(ret.APROVEITAMENTO.status){$("#num_proveitamento_"+idLista).html(ret.APROVEITAMENTO.aproveitamento);$("#tmp_aproveitamento_"+idLista).val(ret.APROVEITAMENTO.aproveitamento)}else{$("#aproveitamento_"+idLista).html("<p>Aproveitamento<br /><span id='num_proveitamento_"+idLista+"'>0</span>%</p>");
$("#tmp_aproveitamento_"+idLista).val(0)}if(ret.GR_QUESTOES.status){var colunas=Array(ret.GR_QUESTOES.questoes.length);var corretas=Array(ret.GR_QUESTOES.questoes.length);var i=0;$(ret.GR_QUESTOES.questoes).each(function(){colunas[i]=this.ID_BCO_QUESTAO;corretas[i]=this.aproveitamento;i++});$("#gr_questoes_"+idLista).show();var gr_questoes=new Highcharts.Chart({chart:{renderTo:"gr_questoes_"+idLista,type:"bar",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:false,width:750,borderWidth:1,borderColor:"#909090"},exporting:{enabled:false},title:{text:"Aproveitamento por Questão (%)"},xAxis:{categories:colunas},yAxis:{min:0,title:{text:"Aproveitamento (%)"}},tooltip:{formatter:function(){return this.y+"% de acertos"}},plotOptions:{bar:{stacking:"normal"}},legend:{enabled:false},series:[{name:"Corretas",data:corretas}],credits:{enabled:false}})}else{$("#gr_questoes_"+idLista).hide()}$("#gr_aluno_"+idLista).hide()}},"json").error(function(){site.fechaAguarde();alert("Falha no servidor! Tente mais tarde.")
})}function modalAluno(idLista){site.aguarde();$("#grid_alunos_"+idLista).jqGrid({url:"listas/CarregarAlunosLista?idLista="+idLista,datatype:"json",colNames:["Código","Aluno","Escola","Turma"],colModel:[{name:"ID_CLIENTE",index:"ID_CLIENTE",width:15,align:"center",search:true,cellattr:site.formataGrid},{name:"ALUNO",index:"ALUNO",width:40,search:true},{name:"ESCOLA",index:"ESCOLA",width:20,search:true},{name:"TURMA",index:"TURMA",width:20,search:true}],onSelectRow:function(id){site.aguarde();$.post("listas/GraficoAluno",{idLista:idLista,idCliente:id},function(ret){site.fechaAguarde();if(ret.status){var universo=parseFloat($("#tmp_aproveitamento_"+idLista).val());var aluno=ret.aproveitamento;var gr_aluno=new Highcharts.Chart({chart:{renderTo:"gr_aluno_"+idLista,type:"column",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:false,width:750,height:300,borderWidth:1,borderColor:"#909090"},exporting:{enabled:false},title:{text:"Aproveitamento Universo x Aluno (%)"},subtitle:{text:"Aluno(a) - "+ret.aluno,style:{fontSize:"14px",fontWeight:"bold"}},xAxis:{categories:["Universo","Aluno(a)"]},yAxis:{min:0,title:{text:"Aproveitamento (%)"}},tooltip:{formatter:function(){return this.y+"%"
}},plotOptions:{column:{stacking:"normal"}},legend:{enabled:false},series:[{name:"Aproveitamento",data:[{y:universo,color:universo>aluno?"#4572A7":"#AA4643"},{y:aluno,color:aluno>universo?"#4572A7":"#AA4643"}]}],credits:{enabled:false}});$("#gr_aluno_"+idLista).show()}else{alert(ret.msg)}},"json");$("#modal_alunos_"+idLista).dialog("close")},rowNum:10,rowList:[10,20,30],pager:"#pg_alunos_"+idLista,sortname:"ALUNO",viewrecords:true,sortorder:"ASC",caption:"Alunos",width:750,height:"auto",scrollOffset:0});$("#grid_alunos_"+idLista).filterToolbar();site.fechaAguarde();$("#modal_alunos_"+idLista).dialog({title:"Selecione um Aluno",open:function(event,ui){$(".ui-dialog-titlebar").show()},modal:true,width:780,heigth:550})}function imprimirGraficos(idLista){window.open("listas/ImprimirGraficos?idLista="+idLista,"Imprimir","width=800,height=600,status=no,scrollbars=yes")}function alteraAnticola(status,idLista){site.aguarde();$.post("listas/alterarAnticola",{idLista:idLista,status:status},function(ret){site.fechaAguarde();
if(!ret.status){site.modal(ret.msg,"Anticola","erro")}},"json").error(function(){site.fechaAguarde();alert("Falha no servidor! Tente mais tarde.")})}function alteraPeriodo(data,tipo,idLista){site.aguarde();$.post("listas/alterarPeriodo",{data:data,tipo:tipo,idLista:idLista},function(ret){site.fechaAguarde();if(!ret.status){site.modal(ret.msg,"Período","erro")}},"json").error(function(){site.fechaAguarde();alert("Falha no servidor! Tente mais tarde.")})}function alteraResultadoAluno(status,idLista){site.aguarde();$.post("listas/alterarResultadoAluno",{idLista:idLista,status:status},function(ret){site.fechaAguarde();if(!ret.status){site.modal(ret.msg,"Resultado do Aluno","erro")}},"json").error(function(){site.fechaAguarde();alert("Falha no servidor! Tente mais tarde.")})}function alteraGabaritoAluno(status,idLista){site.aguarde();$.post("listas/alterarGabaritoAluno",{idLista:idLista,status:status},function(ret){site.fechaAguarde();if(!ret.status){site.modal(ret.msg,"Gabarito do Aluno","erro")
}},"json").error(function(){site.fechaAguarde();alert("Falha no servidor! Tente mais tarde.")})}function alteraTempoVida(tempo,idLista){var regTempo=/^[0-9][0-9]:[0-9][0-9]/;if(regTempo.test(tempo)){$.post("listas/alterarTempoVida",{idLista:idLista,tempo:tempo},function(ret){if(!ret.status){site.modal(ret.msg,"Tempo de Vida","erro")}},"json").error(function(){site.fechaAguarde();alert("Falha no servidor! Tente mais tarde.")})}}function menuLista(menu){var arr=menu.split("_");$("."+arr[2]).css("display","none");$("#"+menu).css("display","")};